---
- name: Gather vSwitch info for target ESXi host
  community.vmware.vmware_vswitch_info:
    hostname: "{{ lookup('env', 'VMWARE_HOST') }}"
    username: "{{ lookup('env', 'VMWARE_USER') }}"
    password: "{{ lookup('env', 'VMWARE_PASSWORD') }}"
    esxi_hostname: "{{ ansible_host }}"
    validate_certs: false
  register: vcenter_add_host_vswitch_info
  delegate_to: localhost

- name: Parse current vSwitch0 uplinks from vSwitch info
  ansible.builtin.set_fact:
    vcenter_add_host_vswitch0_uplinks: >-
      {{
        (
          (
            (
              vcenter_add_host_vswitch_info.hosts_vswitch_info | default({})
            )
            | dict2items
            | map(attribute='value')
            | list
            | first
            | default({})
          ).get('vSwitch0', {}).get('pnics', [])
        )
      }}

- name: Fail if vSwitch0 uplinks cannot be determined
  ansible.builtin.fail:
    msg: >-
      Unable to determine current vSwitch0 uplinks on {{ ansible_host }}.
      Refusing to apply vmware_vswitch update without explicit nics to avoid accidental uplink detachment.
  when: (vcenter_add_host_vswitch0_uplinks | length) == 0

- name: Update vSwitch0 security policy while preserving uplinks
  community.vmware.vmware_vswitch:
    hostname: "{{ lookup('env', 'VMWARE_HOST') }}"
    username: "{{ lookup('env', 'VMWARE_USER') }}"
    password: "{{ lookup('env', 'VMWARE_PASSWORD') }}"
    esxi_hostname: "{{ ansible_host }}"
    switch_name: "vSwitch0"
    nics: "{{ vcenter_add_host_vswitch0_uplinks }}"
    validate_certs: false
    state: present
    network_policy:
      promiscuous_mode: true
      forged_transmits: true
      mac_changes: true
  delegate_to: localhost

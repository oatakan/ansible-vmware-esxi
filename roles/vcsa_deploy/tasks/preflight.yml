---
- name: Determine deployment mode for preflight
  ansible.builtin.set_fact:
    vcsa_deploy_preflight_pull_mode: "{{ vcsa_deploy_vcenter_ova_file is match('^https?://') }}"

- name: Check ovftool presence for datastore-based deployment
  ansible.builtin.stat:
    path: "{{ vcsa_deploy_ovftool }}"
  register: vcsa_deploy_preflight_ovftool_stat
  when: not vcsa_deploy_preflight_pull_mode | bool

- name: Check OVA presence for datastore-based deployment
  ansible.builtin.find:
    paths: "{{ vcsa_deploy_network_mount_dir }}/images"
    patterns: '{{ vcsa_deploy_vcenter_ova_file | default("VMware-vCenter-Server-Appliance-6.7.0.30000*.ova") }}'
  register: vcsa_deploy_preflight_ova_find
  changed_when: false
  failed_when: false
  when: not vcsa_deploy_preflight_pull_mode | bool

- name: Check source OVA URL reachability from ESXi host for pull mode # noqa command-instead-of-module
  ansible.builtin.command: >
    wget --spider --server-response --no-check-certificate
    '{{ vcsa_deploy_vcenter_ova_file }}'
  register: vcsa_deploy_preflight_pull_source_reachability
  changed_when: false
  failed_when: false
  when: vcsa_deploy_preflight_pull_mode | bool

- name: Check target datastore visibility on ESXi host
  ansible.builtin.command: esxcli storage filesystem list
  register: vcsa_deploy_preflight_fs
  changed_when: false
  failed_when: false

- name: Evaluate datastore and OVA readiness
  ansible.builtin.set_fact:
    vcsa_deploy_preflight_datastore_visible: >-
      {{
        vcsa_deploy_target_esx_datastore in
        (vcsa_deploy_preflight_fs.stdout | default(''))
      }}
    vcsa_deploy_preflight_ovftool_ready: >-
      {{
        (vcsa_deploy_preflight_ovftool_stat.stat.exists | default(false)) and
        (vcsa_deploy_preflight_ovftool_stat.stat.executable | default(false))
        if (not vcsa_deploy_preflight_pull_mode | bool) else true
      }}
    vcsa_deploy_preflight_ova_ready: >-
      {{
        (vcsa_deploy_preflight_ova_find is defined) and
        (vcsa_deploy_preflight_ova_find.matched | default(0) | int > 0)
        if (not vcsa_deploy_preflight_pull_mode | bool) else true
      }}
    vcsa_deploy_preflight_pull_source_ready: >-
      {{
        (vcsa_deploy_preflight_pull_source_reachability.rc | default(1) | int == 0)
        if (vcsa_deploy_preflight_pull_mode | bool) else true
      }}

- name: Show VCSA preflight summary
  ansible.builtin.debug:
    msg:
      - "pull_mode={{ vcsa_deploy_preflight_pull_mode | bool }}"
      - "datastore_visible={{ vcsa_deploy_preflight_datastore_visible | bool }}"
      - "ovftool_ready={{ vcsa_deploy_preflight_ovftool_ready | bool }}"
      - "ova_ready={{ vcsa_deploy_preflight_ova_ready | bool }}"
      - "pull_source_ready={{ vcsa_deploy_preflight_pull_source_ready | bool }}"

- name: Fail on preflight issues when fail-fast is enabled
  ansible.builtin.fail:
    msg: |-
      VCSA preflight failed.
      pull_mode={{ vcsa_deploy_preflight_pull_mode | bool }}
      datastore_visible={{ vcsa_deploy_preflight_datastore_visible | bool }}
      ovftool_ready={{ vcsa_deploy_preflight_ovftool_ready | bool }}
      ova_ready={{ vcsa_deploy_preflight_ova_ready | bool }}
      pull_source_ready={{ vcsa_deploy_preflight_pull_source_ready | bool }}
      pull_source_check_output={{
      (vcsa_deploy_preflight_pull_source_reachability.stdout | default('')) ~ ' ' ~
      (vcsa_deploy_preflight_pull_source_reachability.stderr | default('')) }}
  when:
    - vcsa_deploy_preflight_fail_fast | bool
    - >-
      (not vcsa_deploy_preflight_datastore_visible | bool) or
      ((not vcsa_deploy_preflight_pull_mode | bool) and (not vcsa_deploy_preflight_ovftool_ready | bool)) or
      ((not vcsa_deploy_preflight_pull_mode | bool) and (not vcsa_deploy_preflight_ova_ready | bool)) or
      ((vcsa_deploy_preflight_pull_mode | bool) and (not vcsa_deploy_preflight_pull_source_ready | bool))
